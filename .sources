echo -n "Sourcing files... "
if [[ -n "$ZSH_VERSION" ]]; then
    zmodload zsh/datetime  # provides $EPOCHREALTIME (float seconds)
    start_time=$EPOCHREALTIME
else
    start_time=$(date +%s%N)
fi

# Set paths and env first
source_files $DOTFILES_ROOT/config "*.env"
source_files $DOTFILES_ROOT/config "*.paths"

# Source the core shell stuff next
if [ -n "$BASH_VERSION" ]; then
    source_files $DOTFILES_ROOT/config/bash "*.bash"
    source_files $DOTFILES_ROOT/config "*.bash"
fi

if [ -n "$ZSH_VERSION" ]; then
    source_files $DOTFILES_ROOT/config/zsh "*.zsh"
    source_files $DOTFILES_ROOT/config "*.zsh"
fi

# Run commands compatible with all shells
source_files $DOTFILES_ROOT/config "*.rc"

#source_if_exists $DOTFILES_ROOT/.paths
#source_if_exists $DOTFILES_ROOT/.aliases

source_files $DOTFILES_ROOT/config "*.functions"
source_files $DOTFILES_ROOT/functions "*"
source_files $DOTFILES_ROOT/config "*.aliases"

source_files $DOTFILES_LOCAL_ROOT "*"

# finally, run any extra shell commands
source_if_exists $DOTFILES_ROOT/config/.shellrc
if [[ -n "$ZSH_VERSION" ]]; then
    elapsed_ms=$(( (EPOCHREALTIME - start_time) * 1000 ))
    printf "Done. Took %.0fms.\n" "$elapsed_ms"
else
    end_time=$(date +%s%N)
    elapsed_ms=$(( (end_time - start_time) / 1000000 ))
    echo "Done. Took ${elapsed_ms}ms."
fi
unset start_time elapsed_ms
